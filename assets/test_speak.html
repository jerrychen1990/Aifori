<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Web Audio API 测试</title>
	</head>
	<body>
		<table>
			<tr>
				<!-- <td>参数:</td>
				<td><input style="width: 390px;" type="text" name="type" id="type"></td>
				<td> -->
					<button onclick="onSendMessage()">发送消息</button>
				</td>
				<!-- <td>
					<button onclick="onCloseMessage()">断开连接</button>
				</td> -->
			</tr>

		</table>
	</body>

	<script>
		//Web Audio API
		var context;
		try {
			context = new(window.AudioContext || window.webkitAudioContext)();
		} catch (e) {
			alert('您当前的浏览器不支持Web Audio API ');
		}


		//测试
        var wsServer = "ws://localhost:9001/agent/speak_stream";

		/** 
			WebSocket服务连接
		*/
		var objSocket = new WebSocket(wsServer);
		objSocket.onopen = function(evt) {
			onOpen(evt)
		};
		objSocket.onclose = function(evt) {
			onClose(evt)
		};
		objSocket.onmessage = function(evt) {
			onMessage(evt)
		};
		objSocket.onerror = function(evt) {
			onError(evt)
		};

		function onOpen(evt) {
			console.log("Connected to WebSocket server.");
		}

		function onClose(evt) {
			console.log("Disconnected");
		}

		function onError(evt) {
			console.log('Error occured: ' + evt.data);
		}

		function onMessage(evt) { //websocket返回数据信息处理
			console.log('Retrieved data from server: ' + evt.data);

			var reader = new FileReader(); //文件阅读器
			reader.readAsArrayBuffer(evt.data); //读取成ArrayBuffer对象
			reader.onload = function() { //读取完毕
				//解码
				context.decodeAudioData(this.result, function(buffer) {
					playSound(buffer);
				}, function(e) {
					"Error with decoding audio data" + e.err
				});
			}

			//--------onMessage-----end-----------
		}

		//播放声音
		function playSound(buffer) {
			var source = context.createBufferSource(); // 创建一个声音源
			source.buffer = buffer; // 告诉该源播放何物
			source.connect(context.destination); //将该源与硬件相连
			source.start(0); // 开始播放
		}
		
		//发送消息
		function onSendMessage() {
            objSocket.onopen = () => {
                console.log('WebSocket is open now.');
            };
            const message = {
                "agent_id": "test_agent",
                "message": "你好呀，我的名字叫Aifori",
                "voice_config": {
                    "voice_id": "tianxin_xiaoling",
                    "speed": 1,
                    "pitch": 0
                }
            };
            objSocket.send(JSON.stringify(message));
		}

		//关闭连接
		function onCloseMessage() {
			objSocket.close()
		}
	</script>
</html>
