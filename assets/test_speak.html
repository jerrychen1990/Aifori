<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Audio Player</title>
</head>
<body>
		<table>
			<tr>
				<!-- <td>参数:</td>
				<td><input style="width: 390px;" type="text" name="type" id="type"></td>
				<td> -->
					<button onclick="onSendMessage()">发送消息</button>
				</td>
				<!-- <td>
					<button onclick="onCloseMessage()">断开连接</button>
				</td> -->
			</tr>

		</table>
</body>
    <script>
        var audioQueue = [];
        var context = new (window.AudioContext || window.webkitAudioContext)();
        var isPlaying = false;

        var objSocket = new WebSocket('ws://localhost:9001/agent/speak_stream');
        objSocket.onopen = function(evt) {
            onOpen(evt);
        };
        objSocket.onclose = function(evt) {
            onClose(evt);
        };
        objSocket.onmessage = function(evt) {
            onMessage(evt);
        };
        objSocket.onerror = function(evt) {
            onError(evt);
        };

        function onOpen(evt) {
            console.log("Connected to WebSocket server.");
        }

        function onClose(evt) {
            console.log("Disconnected");
        }

        function onError(evt) {
            console.log('Error occurred: ' + evt.data);
        }

        function onMessage(evt) {
            console.log('Retrieved data from server: ' + evt.data);
            console.log('chunk size: ' + evt.data.length);

            var reader = new FileReader();
            reader.readAsArrayBuffer(evt.data);
            reader.onload = function() {
                audioQueue.push(this.result);
                if (!isPlaying) {
                    playNextAudio();
                }
            };
        }

		function playSound(buffer) {
			var source = context.createBufferSource(); // 创建一个声音源
			source.buffer = buffer; // 告诉该源播放何物
			source.connect(context.destination); //将该源与硬件相连
			source.start(0); // 开始播放
		}
		
		//发送消息
		function onSendMessage() {
            objSocket.onopen = () => {
                console.log('WebSocket is open now.');
            };
            const message = {
                "agent_id": "test_agent",
                "message": "你好呀，我的名字叫Aifori",
                "voice_config": {
                    "voice_id": "tianxin_xiaoling",
                    "speed": 1,
                    "pitch": 0
                }
            };
            objSocket.send(JSON.stringify(message));
		}


        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            var audioData = audioQueue.shift();

            context.decodeAudioData(audioData, function(buffer) {
                var source = context.createBufferSource();
                source.buffer = buffer;
                source.connect(context.destination);
                source.onended = function() {
                    playNextAudio();
                };
                source.start(0);
            }, function(e) {
                console.error("Error with decoding audio data: " + e.err);
                playNextAudio();
            });
        }
    </script>
</html>